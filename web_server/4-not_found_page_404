#!/usr/bin/env bash
# Configures nginx to show a custom 404 page with required string

set -e

NGINX_CONF="/etc/nginx/sites-available/default"
NOT_FOUND_HTML="/var/www/html/404.html"
MSG="Ceci n'est pas une page"

# 1. Install nginx if needed
if ! dpkg -s nginx >/dev/null 2>&1; then
	  apt-get update -y
	    apt-get install -y nginx
fi

# 2. Create the custom 404 page
echo "$MSG" > "$NOT_FOUND_HTML"

# 3. Remove any previous custom error_page lines (for idempotency)
sed -i '/error_page 404 \/404.html;/d' "$NGINX_CONF"

# 4. Ensure inside server block: Insert error_page line before last } in server
awk -v epage="    error_page 404 /404.html;\n" '
  BEGIN { in_server=0 }
    /^server[ \t]*{/ { in_server=1 }
      in_server && /^\}/ { print epage; in_server=0 }
        { print }
	' "$NGINX_CONF" > /tmp/default.conf && mv /tmp/default.conf "$NGINX_CONF"

	# 5. Reload nginx
	nginx -t
	service nginx restart
