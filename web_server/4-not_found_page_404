#!/usr/bin/env bash
# Configures nginx so that /404.html contains "Ceci n'est pas une page" and the error_page directive is set

set -e

NGINX_CONF="/etc/nginx/sites-available/default"
PAGE="/var/www/html/404.html"
STRING="Ceci n'est pas une page"

# Install nginx if not present
if ! dpkg -s nginx >/dev/null 2>&1; then
	  apt-get update -y
	    apt-get install -y nginx
fi

# Create the required custom 404 page with NO trailing newline
echo -n "$STRING" > "$PAGE"
chmod 644 "$PAGE"

# Remove any previous error_page line for idempotency
sed -i '/error_page 404/d' "$NGINX_CONF"

# Insert the error_page directive inside server { ... } before the last }
awk -v s="    error_page 404 /404.html;\n" '
  BEGIN {inserver=0}
    /^server[ \t]*{/ {inserver=1}
      inserver && /^\}/ {print s; inserver=0}
        {print}
	' "$NGINX_CONF" > /tmp/default.conf && mv /tmp/default.conf "$NGINX_CONF"

	nginx -t
	service nginx restart
