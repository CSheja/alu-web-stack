#!/usr/bin/env bash
# Configure Nginx to redirect /redirect_me with a 301

set -e

NGINX_CONF="/etc/nginx/sites-available/default"
REDIRECT_URL="https://www.youtube.com/watch?v=QH2-TGUlwu4"

# Install nginx if not present
if ! dpkg -s nginx >/dev/null 2>&1; then
	  apt-get update -y
	    apt-get install -y nginx
fi

# Make sure root directory and index file exist
mkdir -p /var/www/html
[ -f /var/www/html/index.html ] || echo ok > /var/www/html/index.html

# Remove any prior /redirect_me block for idempotency
sed -i '/location = \/redirect_me {/,/}/{d}' "${NGINX_CONF}"

# Insert the redirect after the first root directive
sed -i "/root \/var\/www\/html;/a \    location = /redirect_me {\n        return 301 ${REDIRECT_URL};\n    }" "${NGINX_CONF}"

nginx -t
service nginx restart
